<% content_for :full_width do %>

  <%# <%= link_to "â† #{@chat.meal_plan.name}", meal_plan_path(@chat.meal_plan) %>

  <div class="page-background">
    <div class="chat-page container py-5">

      <div class="chat-header mb-4 text-center">
        <h1 id="chat_title">Let's build your new meal plan with the power of AI</h1>
        <p class="mb-0 fs-5">Chat with your AI-Assistant based on your Profile & Preferences.</p>
      </div>

      <div class="chat-layout row g-4">

        <!-- LEFT -->
        <aside class="col-12 col-lg-4">
          <div class="chat-card card shadow-sm mb-4">
            <div class="card-body">
              <h5 class="card-title mb-3">Profile Information</h5>

              <% if current_user.profile_information.present? %>
                <ul class="chat-meta list-unstyled mb-0">
                  <li>Name: <%= current_user.profile_information.name %></li>
                  <li>Gender: <%= current_user.profile_information.gender %></li>
                  <li>DOB: <%= current_user.profile_information.date_of_birth %></li>
                  <li>Height: <%= current_user.profile_information.height %></li>
                  <li>Weight: <%= current_user.profile_information.weight %></li>
                  <li>
                    Restrictions:
                    <%= if current_user.profile_information.restrictions.present?
                          current_user.profile_information.restrictions
                        else
                          "None"
                        end %>
                  </li>
                  <li>
                    Conditions:
                    <%= if current_user.profile_information.conditions.present?
                          current_user.profile_information.conditions
                        else
                          "None"
                        end %>
                  </li>
                </ul>
              <% else %>
                <p class="text-muted mb-0">No profile information available.</p>
              <% end %>
            </div>
          </div>

          <div class="chat-card card shadow-sm">
            <div class="card-body">
              <h5 class="card-title mb-2">Meal Plan Preferences</h5>
              <h6 class="fw-bold mb-3"><%= @meal_plan.plan_title %></h6>

              <ul class="chat-meta list-unstyled mb-0">
                <li class="mb-2"><em>Plan goal:</em> <%= @meal_plan.goal %></li>
                <li class="mb-2"><em>Diet type:</em> <%= @meal_plan.diet %></li>
                <li class="mb-2"><em>Meals required:</em> <%= @meal_plan.meals_required %></li>
                <li class="mb-2"><em>Other considerations:</em> <%= @meal_plan.additional_preferences %></li>
              </ul>
            </div>
          </div>
        </aside>

        <!-- RIGHT -->
        <section class="col-12 col-lg-8">
          <div class="chat-shell card shadow-sm">

            <div class="card-body border-bottom">
              <h4 class="mb-0">Plan requirements</h4>
            </div>

            <div id="messages-container" class="mb-5" style="height: 70vh; overflow-y: auto;" data-controller="chat-scroll">
              <% @messages.each do |message| %>
                <% if message.role == "user" %>
                  <div class="d-flex justify-content-end mb-3">
                    <div class="chat-user-bubble text-white p-3 rounded-4 shadow-sm" style="max-width: 70%;">
                      <div class="message small">
                        <%= raw(render_markdown(message.content)) %>
                      </div>
                    </div>
                  </div>
                <% elsif message.role == "assistant" %>
                  <div class="d-flex justify-content-start mb-3">
                    <div class="chat-ai-bubble p-3 rounded-4 shadow-sm" style="max-width: 85%;">
                      <%= raw(render_markdown(message.content)) %>
                    </div>
                  </div>
                <% end %>
              <% end %>
            </div>

            <div class="footer-container mt-3 w-100 p-3 border-top bg-white">
              <%= simple_form_for @message, url: user_meal_plan_chat_messages_path(current_user, @meal_plan, @chat) do |f| %>
                <%= f.label :content, "Any adjustments?", class: "form-label" %>

                <div class="chat-input-row">
                  <div class="chat-input-grow">
                    <%= f.input :content,
                          label: false,
                          input_html: { class: "form-control chat-input-field", rows: 2 } %>
                  </div>

                  <div class="chat-input-send">
                    <%= f.button :submit, "Send", class: "btn btn-1 chat-send-btn" %>
                  </div>
                </div>
              <% end %>

              <div class="text-center mt-3">
                <%= link_to "Back to My Meal Plans",
                      user_meal_plans_path(current_user),
                      class: "btn btn-2 px-4" %>
              </div>
            </div>

          </div>
        </section>

      </div>
    </div>
  </div>

<% end %>
